/**
*  Bootstrap-Help-Manager v 0.2.0
*  https://github.com/psalmody/Bootstrap-Help-Manager
*/
var BHM=function(Vertebrate,$,my){return my.helpersurl="/dev/Bootstrap-Help-Manager/bhm.helpers.php",my.pagesurl="/dev/Bootstrap-Help-Manager/bhm.pages.php",my.helper=Vertebrate.Model.Extend({attributes:{id:-1,field_selecter:"",title:"",large:!1,html:""},url:my.helpersurl}),my.page=Vertebrate.Model.Extend({attributes:{id:-1,url:""},url:my.pagesurl}),my.helpers=Vertebrate.Collection.Extend({model:my.helper,url:my.helpersurl}),my.pages=Vertebrate.Collection.Extend({model:my.page,url:my.pagesurl}),my.cp=new my.pages,my.ch=new my.helpers,my}(Vertebrate,jQuery,BHM||{});!function(CKEDITOR,$){var cssfiles=$(document).find('link[rel="stylesheet"]'),arrcss=["body{padding:5px;}"];cssfiles.each(function(){arrcss.push($(this).attr("href"))}),CKEDITOR.config.contentsCss=arrcss,CKEDITOR.config.height=500,CKEDITOR.config.htmlEncodeOutput=!1,CKEDITOR.config.entities=!1}(CKEDITOR,jQuery);var BHM=function(Vertebrate,$,my){var clean=function(what){return"string"!=typeof what?what:what.replace(/([.])|([/])|([ ])/g,"")},renderPage=function(model){var $el=BHM.mc.$el;cleanfilename=clean(model.get("url")),$el.find("ul").append(tmpl($("#templateTabLI").html(),$.extend({},{clean:cleanfilename},model.attributes))),$el.find(".tab-content").append(tmpl($("#templateTabDiv").html(),$.extend({},{clean:cleanfilename},model.attributes))),$el.find("ul li:first").addClass("active"),$el.find(".tab-content .tab-pane:first").addClass("active")},renderHelps=function(model){var $el=BHM.mc.$el,cols=($("#_"+clean(model.get("url"))),BHM.mc.settings.columns.slice(0));cols.push(BHM.mc.settings.addButton);var jsondata=[],helps=BHM.ch.findAll(model.get("id"),"help_page_id");$.each(helps,function(){jsondata.push(this.attributes)}),$el.find("#_"+clean(model.get("url"))).JSONTable({data:jsondata,template:$("#templateHelperRow"),templateParams:{filename:model.get("url")},columns:cols,success:function(){$(".helpHTML").hide()}})},renderHelp=function(model){BHM.mc.$el;if($("#_"+clean(model.get("filename"))).length){var page=BHM.cp.find(model.get("help_page_id"),"id");return renderHelps(page),!0}$("#_"+clean(model.get("filename"))).find("tbody").prepend(tmpl($("#templateHelperRow").html(),model.get()))};return my.cp=BHM.cp||{},my.cp.render=function(){var models=this.models,$el=BHM.mc.$el;$el.find("ul").empty(),$.each(models,function(){renderPage(this)}),$el.prepend($("#templateOpeningText").html())},my.ch=BHM.ch||{},my.ch.render=function(){var pages=BHM.cp.models;BHM.mc.$el;$.each(pages,function(){renderHelps(this)})},my.renderHelp=function(model){return renderHelp(model)},my.renderPage=function(model){return renderPage(model)},my.clean=function(filename){return clean(filename)},my.mc={settings:{addButton:'<button class="btn btn-sm btn-block btn-default addHelper">Add</button>',columns:["Field Selecter","Modal Title","Size","Content","Save"],ajaxFail:!1,templates:"templates/bhm.console.html"},$el:"",render:function(){var self=this;$("#helpsManager").on("click",".nav.nav-tabs a",function(e){e.preventDefault(),$(this).tab("show")});var dfd=$.get(self.settings.templates);$.when(dfd).then(function(data){$(data).appendTo("body"),CKEDITOR.replace("bhmTextareaEditor"),self.$el.append(tmpl($("#templateTabPanel").html(),{}))}).then(function(){return BHM.cp.fetch()}).then(function(){return BHM.ch.fetch()})}},my}(Vertebrate,jQuery,BHM||{});!function($){$.fn.BHMConsole=function(opts){var mc=BHM.mc;mc.settings=$.extend({},mc.settings,opts),mc.$el=this,mc.render();var self=this,getPageFor=function($obj){return BHM.cp.find($obj.closest(".tab-pane").data("page-id"),"id")},getHelpFor=function($obj){return BHM.ch.find($obj.closest("tr").data("help-id"),"id")},getElForHelp=function(model){return $("#help"+model.get("id"))};$(document).on("vertebrate:fetched",function(e,c,ms){c.render()}).on("vertebrate:changeattr",function(e,m,mattr,mchanged){getElForHelp(m).find(".saveHelp").addClass("btn-warning")}),$(this).on("change",'input[type="text"]',function(){var model=getHelpFor($(this)),attr=$(this).data("attr"),val=$(this).val();return val==model.get(attr)?!1:void model.set($(this).data("attr"),$(this).val())}).on("click",'input[type="checkbox"]',function(){var val=$(this).is(":checked")?1:0,model=getHelpFor($(this)),old=model.get($(this).data("attr"));return val==old?!1:void model.set($(this).data("attr"),val)}).on("click",".saveHelp",function(){getHelpFor($(this)).save(),$(this).removeClass("btn-warning")}).on("click",".deleteHelp",function(){var sure=confirm("Are you sure you want to delete this row?");if(!sure)return!1;var model=getHelpFor($(this));BHM.ch.remove(model),$.when(model["delete"]()).done(function(){if(!BHM.ch.findAll(model.get("help_page_id"),"help_page_id")){var page=BHM.cp.find(model.get("help_page_id"),"id");$.when(page["delete"]()).done(function(){var cleanurl=BHM.clean(page.get("url"));$.when($("#_"+cleanurl).fadeOut(300)).then(function(){return $("#tab_"+cleanurl).closest("li").fadeOut(300)}).then(function(){$("#tab_"+cleanurl).closest("li").remove(),$("#_"+cleanurl).remove(),self.find(".nav-tabs li:first a").click()})})}getElForHelp(model).fadeOut(300,function(){$(this).remove()})})}).on("click",".addHelper",function(){var page=getPageFor($(this)),model=new BHM.helper({id:BHM.ch.next("id").toString(),filename:page.get("url"),help_page_id:page.get("id")});BHM.ch.add(model),BHM.renderHelp(model),getElForHelp(model).find(".saveHelp").addClass("btn-warning")}).on("click",".editHelp",function(){var model=getHelpFor($(this)),modal=$("#bhmModal");$("#bhmModalFilename").text(model.get("filename")),$("#bhmModalFieldselecter").text(model.get("field_selecter")),CKEDITOR.instances.bhmTextareaEditor.setData(model.get("html")),modal.data("helpId",model.get("id")),modal.modal()}).on("click","#BHMaddPage",function(){var url=prompt("Enter the relative url of the page to add to:");if(url.length<1)return!1;var id=BHM.cp.next("id").toString(),page=new BHM.page({id:id,url:url}),help=new BHM.helper({id:BHM.ch.next("id"),filename:url,help_page_id:id});BHM.cp.add(page),BHM.ch.add(help),BHM.renderPage(page),BHM.renderHelp(help),page.save(),help.save(),$("#tab_"+BHM.clean(url)).click()}),$("body").on("click","#bhmModal .btn-save-html",function(){var modal=$("#bhmModal"),model=BHM.ch.find(modal.data("helpId"),"id");model.set("html",CKEDITOR.instances.bhmTextareaEditor.getData()),CKEDITOR.instances.bhmTextareaEditor.setData(""),$("#bhmModal").modal("hide")})}}(jQuery),$(document).on("focusin",function(e){$(e.target).closest(".cke_dialog_body").length&&e.stopImmediatePropagation()});