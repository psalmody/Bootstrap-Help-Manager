/**
*  Bootstrap-Help-Manager v 0.3.1
*  https://github.com/psalmody/Bootstrap-Help-Manager
*/
!function($){$.fn.JSONTable=function(options){function formatData(data,status,xhr){if(data.length<1)return"function"==typeof settings.nodata&&settings.nodata(table,status,xhr),self;if("TABLE"!=self.prop("tagName")?(div=self,div.empty(),table=$('<table class="table '+settings.tableClasses+'"><thead></thead><tbody></tbody></table>'),div.append(table),settings.responsive&&div.addClass("table-responsive"),table.hide()):(table=self,div=self.closest("div"),settings.tableClasses&&table.addClass(settings.tableClasses),settings.responsive&&div.addClass("table-responsive")),table.find("thead").length>0?thead=table.find("thead"):(thead=$("<thead></thead>"),table.append(thead)),table.find("tbody").length>0?(tbody=table.find("tbody"),tbody.empty()):(tbody=$("<tbody></tbody>"),table.append(tbody)),thead.find("tr").length<1){var tr=$("<tr></tr>");thead.append(tr),settings.columns.length>0?$.each(settings.columns,function(i){var th=$("<th></th>");tr.append(th),th.html(settings.columns[i])}):$.each(data[0],function(k,v){var th=$("<th></th>");tr.append(th),th.html(k)})}return $(data).each(function(){if(settings.template)return void tbody.append(BHM.tmpl(settings.template.html(),$.extend(this,settings.templateParams)));var tr=$("<tr></tr>");tbody.append(tr),$.each(this,function(k,v){var td=$("<td></td>");(settings.noWraps.indexOf(k)>=0||settings.noWraps.indexOf("allrows")>=0)&&td.addClass("noWrap"),tr.append(td),td.html(v)})}),table.show(),"function"==typeof settings.success&&settings.success(table,status,xhr),self}var settings=$.extend({},{url:!1,data:!1,method:"GET",tableClasses:"table-condensed table-striped",responsive:!1,dataType:"JSON",appendTo:!1,noWraps:[],success:!1,nodata:!1,columns:[],options:{},template:!1,ajaxstatus:!1,templateParams:{}},options);if(!settings.url&&!settings.data)return void console.log("url or data must be specified for JSONTable plugin.");var table,thead,tbody,div,self=this;settings.data?formatData(settings.data,"local, no ajax",!1):$.ajax({method:settings.method,url:settings.url,data:settings.options,dataType:settings.dataType}).done(function(data,status,xhr){formatData(data,status,xhr)}).fail(function(xhr,status,error){"function"==typeof settings.fail&&settings.fail(xhr,status,error)})}}(jQuery);var BHM=function(my){var cache={};return my.tmpl=function tmpl(str,data){var fn=/\W/.test(str)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+str.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):cache[str]=cache[str]||tmpl(document.getElementById(str).innerHTML);return data?fn(data):fn},my}(BHM||{}),BHM=function(Vertebrate,$,my){return my.helper=Vertebrate.Model.Extend({attributes:{id:-1,field_selecter:"",title:"",large:!1,html:""}}),my.page=Vertebrate.Model.Extend({attributes:{id:-1,url:""}}),my.helpers=Vertebrate.Collection.Extend({model:my.helper}),my.pages=Vertebrate.Collection.Extend({model:my.page}),my.cp=new my.pages,my.ch=new my.helpers,my}(Vertebrate,jQuery,BHM||{}),BHM=function(Vertebrate,$,my){var clean=function(what){return"string"!=typeof what?what:what.replace(/([.])|([/])|([ ])/g,"")},renderPage=function(model){var $el=BHM.mc.$el;cleanfilename=clean(model.get("url")),$el.find("ul").append(BHM.tmpl($("#templateTabLI").html(),$.extend({},{clean:cleanfilename},model.attributes))),$el.find(".tab-content").append(BHM.tmpl($("#templateTabDiv").html(),$.extend({},{clean:cleanfilename},model.attributes))),$el.find("ul li:first").addClass("active"),$el.find(".tab-content .tab-pane:first").addClass("active")},renderHelps=function(model){var $el=BHM.mc.$el,cols=($("#_"+clean(model.get("url"))),BHM.mc.settings.columns.slice(0));cols.push(BHM.mc.settings.addButton);var jsondata=[],helps=BHM.ch.findAll(model.get("id"),"help_page_id");$.each(helps,function(){jsondata.push(this.attributes)}),$el.find("#_"+clean(model.get("url"))).JSONTable({data:jsondata,template:$("#templateHelperRow"),templateParams:{filename:model.get("url")},columns:cols,success:function(){$(".helpHTML").hide()}})},renderHelp=function(model){BHM.mc.$el;if($("#_"+clean(model.get("filename"))).length){var page=BHM.cp.find(model.get("help_page_id"),"id");return renderHelps(page),!0}$("#_"+clean(model.get("filename"))).find("tbody").prepend(BHM.tmpl($("#templateHelperRow").html(),model.get()))};return my.cp=BHM.cp||{},my.cp.render=function(){var models=this.models,$el=BHM.mc.$el;$el.find("ul").empty(),$.each(models,function(){renderPage(this)}),$el.prepend($("#templateOpeningText").html())},my.ch=BHM.ch||{},my.ch.render=function(){var pages=BHM.cp.models;BHM.mc.$el;$.each(pages,function(){renderHelps(this)})},my.renderHelp=function(model){return renderHelp(model)},my.renderPage=function(model){return renderPage(model)},my.clean=function(filename){return clean(filename)},my.mc={settings:{addButton:'<button class="btn btn-sm btn-block btn-default addHelper">Add</button>',columns:["Field Selecter","Modal Title","Size","Content","Save"],ajaxFail:!1,templateurl:"",helpersurl:"",pagesurl:""},$el:"",render:function(){var self=this;$("#helpsManager").on("click",".nav.nav-tabs a",function(e){e.preventDefault(),$(this).tab("show")}),BHM.ch.url=this.settings.helpersurl,BHM.cp.url=this.settings.pagesurl,BHM.helper.prototype.url=this.settings.helpersurl,BHM.page.prototype.url=this.settings.pagesurl;var dfd=$.get(self.settings.templateurl);$.when(dfd).then(function(data){$("body").append(data),CKEDITOR.replace("bhmTextareaEditor"),self.$el.append(BHM.tmpl($("#templateTabPanel").html(),{}))}).then(function(){return BHM.cp.fetch()}).then(function(){return BHM.ch.fetch()})}},my}(Vertebrate,jQuery,BHM||{});!function(CKEDITOR,$){var cssfiles=$(document).find('link[rel="stylesheet"]'),arrcss=["body{padding:5px;}"];cssfiles.each(function(){arrcss.push($(this).attr("href"))}),CKEDITOR.config.contentsCss=arrcss,CKEDITOR.config.height=500,CKEDITOR.config.htmlEncodeOutput=!1,CKEDITOR.config.entities=!1}(CKEDITOR,jQuery),function($){$.fn.BHMConsole=function(opts){var mc=BHM.mc;mc.settings=$.extend({},mc.settings,opts),mc.$el=this,mc.render();var self=this,getPageFor=function($obj){return BHM.cp.find($obj.closest(".tab-pane").data("page-id"),"id")},getHelpFor=function($obj){return BHM.ch.find($obj.closest("tr").data("help-id"),"id")},getElForHelp=function(model){return $("#help"+model.get("id"))};$(document).on("vertebrate:fetched",function(e,c,ms){c.render()}).on("vertebrate:changeattr",function(e,m,mattr,mchanged){getElForHelp(m).find(".saveHelp").addClass("btn-warning")}),$(this).on("change",'input[type="text"]',function(){var model=getHelpFor($(this)),attr=$(this).data("attr"),val=$(this).val();return val==model.get(attr)?!1:void model.set($(this).data("attr"),$(this).val())}).on("click",'input[type="checkbox"]',function(){var val=$(this).is(":checked")?1:0,model=getHelpFor($(this)),old=model.get($(this).data("attr"));return val==old?!1:void model.set($(this).data("attr"),val)}).on("click",".saveHelp",function(){getHelpFor($(this)).save(),$(this).removeClass("btn-warning")}).on("click",".deleteHelp",function(){var sure=confirm("Are you sure you want to delete this row?");if(!sure)return!1;var model=getHelpFor($(this));BHM.ch.remove(model),$.when(model["delete"]()).done(function(){if(!BHM.ch.findAll(model.get("help_page_id"),"help_page_id")){var page=BHM.cp.find(model.get("help_page_id"),"id");$.when(page["delete"]()).done(function(){var cleanurl=BHM.clean(page.get("url"));$.when($("#_"+cleanurl).fadeOut(300)).then(function(){return $("#tab_"+cleanurl).closest("li").fadeOut(300)}).then(function(){$("#tab_"+cleanurl).closest("li").remove(),$("#_"+cleanurl).remove(),self.find(".nav-tabs li:first a").click()})})}getElForHelp(model).fadeOut(300,function(){$(this).remove()})})}).on("click",".addHelper",function(){var page=getPageFor($(this)),model=new BHM.helper({id:BHM.ch.next("id").toString(),filename:page.get("url"),help_page_id:page.get("id")});BHM.ch.add(model),BHM.renderHelp(model),getElForHelp(model).find(".saveHelp").addClass("btn-warning")}).on("click",".editHelp",function(){var model=getHelpFor($(this)),modal=$("#bhmModal");$("#bhmModalFilename").text(model.get("filename")),$("#bhmModalFieldselecter").text(model.get("field_selecter")),CKEDITOR.instances.bhmTextareaEditor.setData(model.get("html")),modal.data("helpId",model.get("id")),modal.modal()}).on("click","#BHMaddPage",function(){var url=prompt("Enter the relative url of the page to add to:");if(url.length<1)return!1;var id=BHM.cp.next("id").toString(),page=new BHM.page({id:id,url:url}),help=new BHM.helper({id:BHM.ch.next("id"),filename:url,help_page_id:id});BHM.cp.add(page),BHM.ch.add(help),BHM.renderPage(page),BHM.renderHelp(help),page.save(),help.save(),$("#tab_"+BHM.clean(url)).click()}),$("body").on("click","#bhmModal .btn-save-html",function(){var modal=$("#bhmModal"),model=BHM.ch.find(modal.data("helpId"),"id");model.set("html",CKEDITOR.instances.bhmTextareaEditor.getData()),CKEDITOR.instances.bhmTextareaEditor.setData(""),$("#bhmModal").modal("hide")})}}(jQuery),$(document).on("focusin",function(e){$(e.target).closest(".cke_dialog_body").length&&e.stopImmediatePropagation()});